---
- name: Deploy keycloak container with Podman
  containers.podman.podman_container:
    name: keycloak
    image: "{{ keycloak_image }}"
    state: started
    restart_policy: always
    volumes:
      - "{{ keycloak_data_dir }}:/data:z"
    env:
      CONFIG_PATH: "/data/config"

- name: Ensure systemd service is enabled for keycloak
  copy:
    dest: "/etc/systemd/system/podman-keycloak.service"
    content: |
      [Unit]
      Description=Podman container for keycloak
      Wants=network.target
      After=network.target

      [Service]
      ExecStart=/usr/bin/podman start -a keycloak
      ExecStop=/usr/bin/podman stop -t 10 keycloak
      Restart=always

      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: "0644"

- name: Reload systemd and enable service for keycloak
  systemd:
    daemon_reload: yes
    name: podman-keycloak.service
    enabled: yes
    state: started
