---
- name: Deploy wazuh container with Podman
  containers.podman.podman_container:
    name: wazuh
    image: "{{ wazuh_image }}"
    state: started
    restart_policy: always
    volumes:
      - "{{ wazuh_data_dir }}:/data:z"
    env:
      CONFIG_PATH: "/data/config"

- name: Ensure systemd service is enabled for wazuh
  copy:
    dest: "/etc/systemd/system/podman-wazuh.service"
    content: |
      [Unit]
      Description=Podman container for wazuh
      Wants=network.target
      After=network.target

      [Service]
      ExecStart=/usr/bin/podman start -a wazuh
      ExecStop=/usr/bin/podman stop -t 10 wazuh
      Restart=always

      [Install]
      WantedBy=multi-user.target
    owner: root
    group: root
    mode: "0644"

- name: Reload systemd and enable service for wazuh
  systemd:
    daemon_reload: yes
    name: podman-wazuh.service
    enabled: yes
    state: started
